{% extends "layout.html" %}

{% block content %}
<h1 class="mb-4">Streaming Resume Analyzer</h1>

<form id="resumeForm" enctype="multipart/form-data" class="mb-3">
    <input type="file" id="resumeFile" class="form-control mb-2" accept=".pdf,.txt" required>
    <button type="submit" class="btn btn-primary">Analyze Resume</button>
</form>

<div id="streamingOutput" class="border p-3 rounded bg-light" style="min-height: 200px; white-space: pre-wrap; overflow-y: auto;">
    <!-- Live streamed AI output will appear here -->
</div>

<div id="status" class="mt-2 text-muted"></div>

{% endblock %}

{% block scripts %}
<script>
const form = document.getElementById("resumeForm");
const output = document.getElementById("streamingOutput");
const status = document.getElementById("status");

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById("resumeFile");
    if (!fileInput.files.length) return alert("Please select a file.");

    const file = fileInput.files[0];

    // Read the file as text (PDF requires server-side extraction)
    const formData = new FormData();
    formData.append("file", file);

    output.innerHTML = "";
    status.textContent = "Connecting to server...";

    // Create a WebSocket connection
    const ws = new WebSocket("ws://" + window.location.host + "/ws/resume");

    ws.onopen = () => {
        status.textContent = "Streaming analysis...";
        // Send file content as text (for PDFs, server will extract)
        ws.send(file.name.endsWith(".pdf") ? "PDF uploaded" : fileInput.value);
    };

    ws.onmessage = (event) => {
        const data = event.data;
        if (data.startsWith("Error:")) {
            status.textContent = data;
            ws.close();
        } else {
            output.textContent += data;
            output.scrollTop = output.scrollHeight;
        }
    };

    ws.onclose = () => {
        status.textContent = "Analysis complete.";
    };
});
</script>
{% endblock %}
